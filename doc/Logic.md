## 目的

固定した **h（有効磁場）** のもとで、
**SCFで自己無撞着解（Δ(r), n1(r), n2(r)）を得ながら**、
[
N(\mu;h)=N_1(\mu;h)+N_2(\mu;h)\approx N_{\text{target}}
]
となる **μ（平均化学ポテンシャル）** を見つける。

さらに、h を変えていき（スキャンし）、各 h に対して
[
P_{\text{out}}(h)=\frac{N_1-N_2}{N_1+N_2}
]
を **結果として取得**する（Pは入力固定しない）。

---

## 全体構造（入れ子）

* **外側ループ（hスキャン）**：h を変えて計算を繰り返す（warm start 推奨）
* **中側ループ（μ探索）**：μを変えて N を N_target に合わせる
* **内側ループ（SCF）**：与えた μ1,μ2 で Δ(r) が変わらなくなるまで回す

---

## 手順 A：h をスキャンする（最外側）

1. 計算したい h の列（例：0 → h_max を刻み）を用意
2. for each h:

   * 手順 0〜1（μ探索）を実行して μ(h) を決める
   * 収束解から (N_1,N_2,N) と (P_{\text{out}}) を記録
   * 次の h では直前の収束状態（Δ, n1, n2, μ）を seed にして開始（warm start）

---

## 手順 0：μ探索のための「挟み込み区間」を自動で作る（bracket）

二分法は「解を挟む2点」がないと始まりません。だから最初に自動で作る。

### 0-1) 初期中心 μ0 と初期幅 w を決める

* μ0 は前回の解（warm start）、または 0 など
* w は小さめ（例 1〜2）でOK

### 0-2) 収束した評価点だけを集める

評価関数（固定した h の下で）：

* (\mu_1=\mu+h,\ \mu_2=\mu-h) をセット
* **SCFを内側で収束**させる
* 収束したら (N(\mu;h)) を計算して
  [
  f(\mu)=N(\mu;h)-N_{\text{target}}
  ]
  を得る

### 0-3) 幅を広げながら、符号反転する2点を探す

* μ = μ0 − w, μ0 + w を評価
* **収束した点**が増えたら、その中から
  [
  f(\mu_a)\cdot f(\mu_b)\le 0
  ]
  を満たすペアがあるか探す
* なければ w を倍にして繰り返す（例：最大20回）

> 重要：**bracket判定は“SCFが収束した点だけ”でやる。未収束点は採用しない。**

見つかったら、その2点を

* lo（μが小さい側）
* hi（μが大きい側）

として次へ。

---

## 手順 1：二分法で μ を詰める（μ探索）

以後は lo/hi の間で収束解を保ちながら詰める。

繰り返し（最大 maxMuIter 回）：

### 1-1) 中点 μmid を取る

[
\mu_{\text{mid}} = \frac{\mu_{\text{lo}}+\mu_{\text{hi}}}{2}
]

### 1-2) seed を選んで SCF を回す（未収束を減らすコツ）

* μmid に近い側（lo か hi）の **収束済み state** を seed にする
  （Δ, n1, n2 を持ち越す＝warm start）
* (\mu_1=\mu_{\text{mid}}+h,\ \mu_2=\mu_{\text{mid}}-h) をセット
* **SCFを内側ループで収束**させる

### 1-3) SCFが収束したら N を計算し、誤差判定

* (N_{\text{mid}}=N(\mu_{\text{mid}};h)) を計算
* (|N_{\text{mid}}-N_{\text{target}}|\le \epsilon_N) なら終了（μ確定）

### 1-4) lo/hi の更新（符号で決める）

* (f(\mu)=N(\mu;h)-N_{\text{target}})
* (f(\mu_{\text{lo}})\cdot f(\mu_{\text{mid}})\le 0) なら

  * hi ← mid
* そうでなければ

  * lo ← mid

更新するときは、lo/hi の **評価点（state, N, f）も一緒に更新**する。

---

## SCFが未収束になったときの処理（必須ルール）

二分を壊さないための扱いを固定する。

### ルールA：未収束点は bracket の片側として採用しない

* lo と hi は常に **収束済み点**に保つ

### ルールB：未収束なら区間を縮めて次へ（“収束側へ寄せる”）

* mid が未収束の場合、mid は捨てる
* seed に使った側（収束側）へ寄せるように区間だけ更新

  * seed が lo 由来なら → hi = mid
  * seed が hi 由来なら → lo = mid
* そして次の mid を試す

---

## 内側：SCF（秩序パラメータが一定になるまで）

各 μ 評価で必ずこれをやる（h固定、μ固定の下で）。

繰り返し（最大 maxScfIter 回）：

1. 現在の Δ, n1, n2, μ1, μ2 から BdG 行列を作る
2. 対角化して準粒子状態を得る
3. Δ_new(r), n1_new(r), n2_new(r) を計算
4. 混合して更新（例：α）
5. (|\Delta_{\text{new}}-\Delta|) などが tol 未満なら収束

---

## 最終出力

### 各 h について出す

* 見つかった μ（→ μ1,μ2）
* そのときの **収束状態**：Δ(r), n1(r), n2(r)
* 粒子数：N1, N2, N
* **結果としての偏極**：(P_{\text{out}}=(N_1-N_2)/(N_1+N_2))

### hスキャン全体として出す

* (h \mapsto \mu(h))
* (h \mapsto P_{\text{out}}(h))
* （必要なら）ギャップの指標やエネルギー等の物理量
